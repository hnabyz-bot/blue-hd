# Agent 작업 가이드 (완전판)

---

## 📋 작업 원칙 (Agent 지침)

### 🔴 최우선 원칙 (절대 법칙)

**리소스 최소화 - Agent의 생명줄**

- **토큰 낭비 금지**: 불필요한 파일 읽기, 중복 분석, 장황한 설명 절대 금지
- **Budget 엄수**: 작업 시작 전 예상 토큰 소비량 계산, 한도 초과 시 중단
- **효율 우선**: 같은 결과를 얻을 수 있다면 항상 더 짧은 경로 선택
- **컨텍스트 관리**: 큰 파일은 필요한 부분만 읽기 (offset/limit 활용)
- **도구 선택**: Grep/Glob 가능한 작업을 Task로 하지 않기

**리소스 낭비 예시 (절대 금지)**
- ❌ 전체 파일을 여러 번 읽기 → ✅ 한 번 읽고 메모리에 보관
- ❌ 1000줄 파일 전체 읽기 → ✅ 필요한 100줄만 읽기 (offset/limit)
- ❌ 같은 분석을 반복 → ✅ 결과를 문서에 저장하고 재사용
- ❌ 긴 설명과 예시 나열 → ✅ 핵심만 1-2줄로 전달
- ❌ Task agent로 단순 검색 → ✅ Grep/Glob 직접 사용
- ❌ 검증 스크립트 여러 번 생성 → ✅ 한 번 생성하고 재사용

**Budget 관리 규칙**
1. **작업 전 예측**: 예상 토큰 소비 > 남은 Budget의 50% → 경고
2. **진행 중 모니터링**: 매 단계마다 남은 Budget 확인
3. **임계값 도달 시**: Budget < 20% 남음 → 작업 즉시 중단, 상태 저장
4. **최적화 필수**: 모든 작업은 "더 적은 토큰으로 가능한가?" 질문 먼저

### 핵심 원칙
1. **간결성**: 불필요한 설명 금지, 요점만 간단히 전달
2. **점진성**: 복잡하게 한번에 하지 말고, 단계별로 진행
3. **맥락 유지**: 전체 프로젝트 이해하고 논점에서 벗어나지 않기
4. **문서화**: 작업 방향, 순서, TODO를 md 파일에 실시간 반영
5. **투명성**: 가정은 명시, 불확실하면 멈추기

### 작업 흐름
1. Pre-flight Check (50개 이상 작업 시)
2. 파일 읽기 → 현재 상태 파악
3. 가정 명시 → 변경 계획 수립
4. 백업 생성 → 한 단계씩 실행
5. 즉시 검증 → 다음 단계
6. 완료 후 문서 업데이트

### 필수 체크사항
- [ ] 파일 존재 및 경로 확인
- [ ] 편집 전 정확한 내용 읽기
- [ ] 컨텍스트 포함하여 교체 (앞뒤 3-5줄)
- [ ] 편집 후 즉시 검증 실행
- [ ] 백업 생성 (자동 트리거 시점에)

### 오류 방지
- ❌ 추측으로 편집: 반드시 읽고 확인
- ❌ 큰 블록 한번에 교체: 단계별로 나눠서
- ❌ 하드코딩: 검색으로 동적 확인
- ❌ 병렬 의존 작업: 순차 실행
- ❌ 가정 숨기기: 모든 가정은 명시

---

## 🛑 필수 멈춤 지점 (Agent는 여기서 반드시 정지)

### 자동 진행 금지 상황 (STOP 조건)

1. **데이터 불일치 > 10%**: Excel vs 원본 파일 매칭률 90% 미만
2. **범위 외 신호 > 20개**: 원본에 없는 신호가 20개 초과
3. **핀 중복 발견**: Level 1 검증 실패
4. **예상 출력 개수 불일치**: (원본 + 추가 - 삭제) ≠ 예상 출력 (오차 5% 초과)
5. **패턴 인식 실패**: 신규 패턴 발견 시 (기존 규칙에 없음)
6. **Excel 신뢰도 < 70점**: 데이터 품질 불량
7. **백업 실패**: 체크포인트 생성 불가

### 멈춤 지점에서 해야 할 일

1. 현재까지 분석 결과 요약
2. 불일치 항목 구체적 제시 (최대 5개)
3. 예상 원인 2-3가지 제시 (가능성 % 포함)
4. 사용자에게 선택지 제공:
   - A) 범위 내 항목만 작업 (권장)
   - B) Excel 재확인 후 재시작
   - C) 전체 작업 (위험)
   - D) 작업 취소

---

## 💭 가정 명시 규칙

### 가정이 필요한 상황
- Excel 컬럼명이 명확하지 않을 때
- 신호명 매핑이 1:1이 아닐 때
- 숫자 범위가 애매할 때
- 파일 형식이 불명확할 때
- 패턴이 일관되지 않을 때

### 가정 명시 필수 항목
1. **가정 내용**: 무엇을 가정하는가
2. **근거**: 왜 그렇게 가정했는가
3. **위험도**: 낮음/중간/높음 (확신도 %)
4. **검증 방법**: 어떻게 확인할 것인가
5. **실패 시 대응**: 틀렸을 때 어떻게 할 것인가

### 확신도별 행동

- **확신 > 90%**: 진행 → 사후 검증
- **확신 70-90%**: 가정 명시 → 샘플 테스트 → 진행
- **확신 < 70%**: 작업 중단 → 사용자 질문

---

## 🔍 작업 전 필수 사전 분석 (Pre-flight Check)

### 대량 작업 시작 전 (50개 이상 변경)

**Phase 1: 데이터 소스 신뢰도 평가**

1. **구조적 완전성** (Pass/Fail)
   - 헤더 행 존재
   - 핀 번호 컬럼 존재
   - 신호명 컬럼 존재 (old/new)
   - 빈 행 < 10%

2. **데이터 일관성** (점수화 /100)
   - 핀 번호 형식 일관성
   - 신호명 네이밍 규칙
   - 컬럼 채움률

3. **범위 합리성** (경고 수준)
   - 변경 비율 > 50%: 경고
   - 삭제 비율 > 20%: 경고
   - 신규 추가 > 30%: 경고

**신뢰도 판정**
- 90점 이상: 자동 진행
- 70-89점: 경고 표시 후 진행
- 50-69점: 사용자 확인 필수
- 50점 미만: 진행 불가

**Phase 2: 통계 수집 (5분 이내)**
- 원본 파일 신호 개수
- Excel 매핑 개수 (변경/추가/삭제)
- 예상 출력 신호 개수
- 범위 외 추정 항목 개수

**Phase 3: 이상치 탐지**
- 같은 핀에 여러 신호 매핑
- Excel에만 있고 원본에 없는 신호 (10개 이상)
- 패턴 불일치

**Phase 4: 진행 조건 판단**
- 통계가 합리적 범위 → 자동 진행
- 10% 이상 이상치 → 사용자 확인 후 진행

---

## 🎯 작업 범위 결정 프로토콜

### 작업 시작 전 필수 확인

1. **원본 파일 분석**: 입력 파일에 실제 존재하는 신호만 작업 대상

2. **Excel 매핑 검증**:
   - "140um 신호" 컬럼이 비어있으면 → 신규 신호 (범위 외 가능성)
   - "140um 신호"가 원본 파일에 없으면 → 사용자 확인 필요
   - 매칭률 < 90% → 멈춤 지점

3. **범위 외 항목 보고**:
   - 작업 완료 후 "범위 외로 추정되는 N개 신호" 명시
   - 샘플 5개 제시하여 사용자 판단 요청

---

## 📊 작업 분석 방법론

### Step 1: 데이터 소스 파악
- 입력 파일 구조 분석 (샘플 확인)
- Excel: openpyxl로 파싱, 데이터 구조 파악
- XDC: 정규식으로 핀/신호 추출

### Step 2: 변경점 통계
- 유지/변경/삭제/추가 항목 분류
- 작업량 산정 (10개 이하: 수동, 10개 이상: 스크립트)

### Step 3: 작업 순서 수립
- 의존성 고려 (삭제 → 변경 → 추가)
- 검증 시점 계획 (중간 검증 + 최종 검증)

---

## 🔧 대량 작업 전략

- **10개 미만**: 직접 편집
- **10개 이상**: Python 스크립트 생성 (매핑 테이블 기반)
- **패턴 작업**: Excel/CSV 데이터를 순회하며 변환 적용

---

## 💾 자동 백업 트리거

### 필수 백업 시점 (자동)

1. **최초 원본 파일 읽기 직후**: `{파일명}_original_backup.ext`
2. **10개 이상 변경 전**: `{파일명}_before_bulk_{timestamp}.ext`
3. **각 주요 단계 완료 후**: `{파일명}_checkpoint_{N}.ext`
4. **검증 실패 직전**: `{파일명}_validation_failed_{timestamp}.ext`
5. **사용자 확인 대기 전**: `{파일명}_before_confirm_{timestamp}.ext`

### 백업 보존 정책
- **최초 백업**: 삭제 금지 (원본 보존)
- **체크포인트**: 작업 완료 후 사용자 확인 시까지 보존
- **타임스탬프 백업**: 작업 완료 후 정리 가능 (7일 보존 권장)

### 백업 실패 시 대응
- 원인: 디스크 공간 부족 / 권한 없음
- 영향: 롤백 불가능
- 대응: **작업 즉시 중단**

---

## 📊 진행률 보고 규칙

### 대량 작업 시 (50개 이상)

**진행률 표시 간격**
- 10개 단위로 보고
- 예상 소요 시간 제시 (처음 10개 기준 추정)
- 중간 검증 (50% 시점)

**보고 포함 항목**
- 진행률 (N/M, %)
- 진행 바 (시각적)
- 완료된 작업 항목
- 남은 작업 항목
- 예상 완료 시간
- 마지막 작업 내용 (OK/FAIL)

**중간 검증 (50% 지점)**
- 랜덤 10개 샘플 검증
- 오류 발견 시 즉시 중단
- 문제 없으면 계속 진행

---

## ✅ 검증 레벨 정의

### Level 1 - 필수 검증 (항상 실행)
- 핀 중복 검사: 0개여야 함
- 문법 검사: XDC 문법 오류 없음
- 파일 존재: 출력 파일 생성됨

### Level 2 - 완전성 검증 (작업 완료 시)
- 신호 개수: 예상 개수와 일치 (오차 5% 허용)
- LVDS 페어: 모든 _p/_n 쌍 존재
- 필수 신호: 문서화된 신호 모두 존재

### Level 3 - 교차 검증 (사용자 요청 시)
- Excel vs XDC 매핑 확인
- 원본 vs 출력 diff 분석
- 범위 외 항목 보고

### 검증 실패 기준
- **Level 1 실패**: 작업 중단, 즉시 수정 (P0)
- **Level 2 실패**: 경고 + 재작업 여부 사용자 확인 (P1)
- **Level 3 불일치**: 정보 제공, 작업 계속 가능 (P2-P3)

### "검증해" 명령 해석
- **기본**: Level 1 + Level 2
- **"상세히 검증해"**: Level 1 + Level 2 + Level 3
- **"문법만 검증해"**: Level 1만

---

## 🧪 검증 스크립트 자동 생성 규칙

### 필수 생성 조건 (하나라도 해당 시)
1. 50개 이상 변경 작업
2. LVDS 페어 작업 (완전성 검증 필요)
3. 핀 매핑 작업 (중복 검사 필요)
4. 사용자가 "검증해" 명령 사용 시

### 검증 스크립트 필수 포함 기능
- 핀 중복 검사 (Level 1)
- 신호 개수 검사 (Level 2)
- LVDS 페어 완전성 검사 (Level 2)
- 명확한 통과/실패 판정

### 검증 스크립트 위치
- 파일명: `verify_{작업명}.py`
- 위치: 출력 파일과 같은 디렉토리

---

## 📐 데이터 해석 규칙

### 공통 규칙
- Excel/CSV에서 `-` 또는 빈칸: "변경 없음" (삭제 아님)
- `NC` 또는 `No Connect`: 삭제 대상
- 대소문자 구분: 원본과 동일하게 유지

### 숫자 표기 정규화
- Excel: `SIGNAL_05` (2자리) → XDC: `SIGNAL_5` (1자리) 허용
- 검증 시 정규화 함수 사용 (선행 0 제거)

### 신호명 매핑 우선순위
1. 정확히 일치 (exact match)
2. 정규화 후 일치 (normalized match)
3. 핀 번호 기반 추정 (pin-based inference)
4. 불일치 → 사용자 확인

### FPGA XDC 특수 규칙
- LVDS 신호: `_p` (positive) + `_n` (negative) 페어로 존재
- Array 표기 변환: `{SIGNAL[N]}` → `SIGNAL_N` (중괄호와 대괄호 제거)
- IOSTANDARD: 같은 Bank는 동일 표준 사용

### 의심스러운 데이터
- 같은 핀에 여러 신호 매핑 → 사용자 확인 필요
- 범위가 불명확 → 데이터 소스 재확인
- 새로운 패턴 발견 → 샘플 테스트 후 적용

---

## 🚨 에러 보고 템플릿

### 보고 시 포함 필수 정보 (4W)

1. **What**: 무엇이 실패했는지 (구체적)
2. **Where**: 어디서 발생했는지 (파일:라인)
3. **Why**: 왜 발생했는지 (추정 원인)
4. **hoW**: 어떻게 해결할지 (다음 액션)

### 추가 포함 항목
- 영향도 (치명적/높음/중간/낮음)
- 우선순위 (P0/P1/P2/P3/P4)
- 해결 방안 (단계별)

---

## 🎯 문제 해결 우선순위 매트릭스

### 심각도 × 영향도 분류

| 심각도 | 영향도 높음 | 영향도 중간 | 영향도 낮음 |
|--------|------------|------------|------------|
| **치명적** | P0: 즉시 중단 | P1: 다음 단계 전 해결 | P2: 작업 완료 후 |
| **높음** | P1: 다음 단계 전 | P2: 작업 완료 후 | P3: 사용자 판단 |
| **중간** | P2: 작업 완료 후 | P3: 사용자 판단 | P4: 문서화만 |
| **낮음** | P3: 사용자 판단 | P4: 문서화만 | P4: 문서화만 |

### 문제 분류 기준

**P0 (즉시 중단)**
- 핀 중복 발견
- 문법 오류 (XDC 파싱 실패)
- 파일 쓰기 실패
- 백업 생성 실패

**P1 (다음 단계 전 해결)**
- 10% 이상 매핑 실패
- LVDS 페어 불완전 (5개 이상)
- 예상 개수 불일치 (5% 초과)
- Excel 신뢰도 < 70점

**P2 (작업 완료 후 해결)**
- 범위 외 신호 발견 (< 20개)
- 신호명 표기 차이 (정규화 가능)
- 경미한 패턴 불일치

**P3 (사용자 판단)**
- 최적화 가능한 부분
- 추가 분석 제안
- 대안 방법 제시

**P4 (문서화만)**
- 경미한 발견사항
- 참고 정보
- 통계 정보

---

## 🔄 재시도 전략

### 자동 재시도 조건

**재시도 가능 오류**
- 파일 읽기 실패: 최대 3회, 1초 간격
- 네트워크 오류: 최대 3회, 지수 백오프 (1s, 2s, 4s)
- 패턴 매칭 실패: 정규화 후 1회 재시도

**재시도 금지 조건**
- 사용자 입력 오류 (파일 경로 틀림)
- 논리적 오류 (중복 핀, 데이터 모순)
- 영구적 오류 (파일 없음, 권한 부족)

### 재시도 로그 포함 항목
- 시도 회차 (N/3)
- 시간
- 결과 (성공/실패)
- 원인
- 다음 액션 (재시도/중단)

---

## ⏮️ 작업 취소 및 되돌리기 절차

### 사용자 중단 요청 시

1. **현재 진행 상황 보고**
   - 완료된 단계
   - 진행 중인 단계 (진행률)
   - 대기 중인 단계

2. **사용 가능한 체크포인트 제시**
   - 원본 상태
   - 각 단계별 체크포인트
   - 현재 상태 유지

3. **선택지 제공**
   - A) 특정 체크포인트로 롤백 (권장 제시)
   - B) 원본으로 완전 복원
   - C) 현재 상태 유지

### 체크포인트 복원 절차
1. 현재 파일 임시 저장 (문제 분석용)
2. 선택한 체크포인트 복원
3. 복원 완료 보고

### 부분 완료 상태 유지 시 경고
- 불완전 상태 명시
- 위험 요소 설명
- 권장 사항 제시
- 재확인 요청

---

## 💬 사용자 상호작용 프로토콜

### 명령어 해석 우선순위

**"검증해/확인해/체크해" = 읽기 전용 모드**
- ✅ 파일 읽기
- ✅ 분석 스크립트 실행
- ✅ 통계 출력
- ✅ 검증 스크립트 생성
- ❌ 파일 수정 금지
- ❌ 백업 생성 금지

**"작성해/생성해/수정해" = 파일 변경 허용**

### 질문 필요 시점

**즉시 질문 (작업 중단)**
- 데이터 모순 발견
- 삭제 대상이 애매함
- 범위/채널 불명확
- 매칭률 < 90%

**확인 후 진행 (가정 명시)**
- 패턴이 명확하지만 확신 80% 이하
- 영향 범위가 크지 않음
- 재시도 가능

**진행 후 보고**
- 확신 90% 이상
- 검증으로 확인 가능
- 롤백 가능

---

## 📝 작업 완료 보고서 표준 템플릿

### 필수 포함 항목

**요약**
- 입력 파일 (N개 신호)
- 출력 파일 (M개 신호)
- 변경 내역 (+X, -Y, 수정 Z)
- 소요 시간

**검증 결과**
- Level 1 결과
- Level 2 결과
- Level 3 결과 (있는 경우)

**작업 내역**
- 단계별 상세 내용
- 각 단계 완료 여부

**범위 외 항목** (있는 경우)
- 총 개수
- 예시 (5개)
- 권장사항

**생성 파일**
- 최종 출력 파일
- 검증 스크립트
- 백업 파일 목록

---

## 🐍 Python 스크립트 작성 규칙

### Windows 환경 필수 처리
- UTF-8 인코딩 설정 (한글 출력 시)
- Raw string 사용 (경로 처리)
- 예외 처리 (FileNotFoundError, PermissionError, Exception)

### 출력 형식 표준
- 섹션 구분: `=` 반복
- 성공: `OK:` (Windows 안전)
- 실패: `FAIL:`, `ERROR:`
- 경고: `WARNING:`

---

## 🛠️ 문제 해결 패턴

| 문제 유형 | 원인 | 해결 방법 | 우선순위 |
|----------|------|----------|---------|
| 교체 실패 | 공백/개행 불일치 | 해당 라인을 정확히 읽어 확인 | P1 |
| 중복 핀 | 데이터 충돌 | Excel 재확인, 주석 처리 검증 | P0 |
| 누락 항목 | 범위 오해석 | 데이터 소스 재분석 | P1 |
| 대량 오류 | 패턴 오류 | 샘플 테스트 후 전체 적용 | P2 |
| 의존성 오류 | 순서 잘못 | 작업 순서 재검토 | P1 |
| 범위 외 신호 | 신규 신호 포함 | Pre-flight Check로 사전 탐지 | P2 |
| 백업 실패 | 디스크/권한 | 공간 확보, 권한 확인 | P0 |
| 검증 실패 | 불완전 작업 | 롤백 후 재시도 | P1 |

---

## ✓ 작업 체크리스트

### 작업 전
- [ ] 입력 파일 존재 확인
- [ ] Excel 신뢰도 평가 (품질 체크)
- [ ] Pre-flight Check 실행 (50개 이상 작업 시)
- [ ] 가정 명시 (불확실한 부분)
- [ ] 백업 디렉토리 준비 (공간 확인)
- [ ] 범위 외 항목 확인
- [ ] 작업 순서 계획 수립

### 작업 중
- [ ] 자동 백업 (트리거 시점마다)
- [ ] 단계별 즉시 검증
- [ ] 진행률 보고 (10개 단위)
- [ ] 중간 검증 (50% 시점)
- [ ] 실패 시 재시도 (최대 3회)
- [ ] 진행 상황 문서 업데이트

### 작업 후
- [ ] 최종 검증 스크립트 실행 (Level 1 + Level 2)
- [ ] 성공 기준 모두 충족 확인
- [ ] 범위 외 항목 보고
- [ ] 학습 패턴 저장 (재사용)
- [ ] 작업 이력 문서화 (표준 템플릿)
- [ ] 임시 파일 정리 (체크포인트 제외)

---

## 🔄 불확실성 처리 전략

**불확실도 Level 1 (높음)**: 작업 중단 → 사용자 질문
- 데이터 모순 (Excel과 파일 불일치)
- 명확한 규칙 없음
- 영향도가 큰 결정
- 확신 < 70%

**불확실도 Level 2 (중간)**: 보수적 접근 → 가정 명시 + 문서화
- 샘플 테스트 먼저
- 가정을 명시하고 진행
- 검증 강화
- 확신 70-90%

**불확실도 Level 3 (낮음)**: 진행 → 사후 검증
- 패턴이 명확함
- 작은 범위 작업
- 쉽게 되돌릴 수 있음
- 확신 > 90%

---

## 💾 에러 복구 전략

### 체크포인트 생성 시점
- 작업 시작: `원본_backup_YYYYMMDD.ext`
- 주요 단계 완료: `파일명_checkpoint_N.ext`
- 대량 작업 전: `파일명_before_bulk.ext`
- 50% 완료: `파일명_checkpoint_50pct.ext`

### 롤백 절차
1. 문제 발생 시점 파악
2. 해당 체크포인트로 복원
3. 문제 원인 분석 후 재작업
4. 재시도 (최대 3회)

---

## 🧪 샘플 기반 검증

### 테스트 범위 결정
- N < 10: 전체 검토
- 10 ≤ N < 50: 처음 3개 샘플 테스트
- N ≥ 50: 처음/중간/끝 각 2개씩 (총 6개)

### 샘플 검증 절차
1. 대표 샘플 선택 (다양한 패턴 포함)
2. 수동으로 변경 적용
3. 검증 스크립트 실행
4. 통과 시 전체 적용, 실패 시 패턴 수정

### 전체 적용 후 Spot Check
- 무작위 5% 샘플링
- 경계값 확인 (첫번째, 마지막, 중간)
- 예외 케이스 집중 검토

---

## 🎛️ 도구 선택 결정 트리

**파일 수정 시**
- 1개 수정 → 직접 편집
- 2-5개 독립적 수정 → 직접 편집
- 10개 이상 패턴 작업 → Python 스크립트 생성
- 전체 재생성 → 새 파일 작성

**검증 시**
- 간단 확인 → 검색, 읽기
- 통계/카운트 → Python one-liner
- 복잡 검증 → Python 스크립트 파일 생성 (자동)

**백업 시**
- 원본 수정 전 → 자동 백업 (트리거)
- git 사용 가능 → git commit

---

## ⚖️ 작업 범위 통제

### 최소 요구사항 (Must)
- 요청받은 파일 생성/수정
- 기본 검증 (Level 1 + Level 2)
- 간단한 작업 기록

### 권장 사항 (Should)
- 자동 검증 스크립트 생성 (50개 이상 시 필수)
- 상세 작업 기록 문서화 (표준 템플릿)
- 백업 파일 생성 (자동)

### 선택 사항 (Nice-to-have)
- 추가 분석 도구
- 상세 리포트 문서
- 시각화/통계

---

## 📚 작업 패턴 학습 및 재사용

### 작업 완료 시 자동 저장 항목

**발견한 패턴 (YAML 형식)**
- 패턴 이름
- 규칙
- 신뢰도 (%)
- 샘플
- 컨텍스트

**발생한 문제 및 해결책 (YAML 형식)**
- 문제 설명
- 원인
- 해결 방법
- 예방 방법
- 우선순위

**최적화 포인트 (YAML 형식)**
- 영역
- 개선 전
- 개선 후
- 향상도
- 적용 기준

### 다음 작업 시 활용
- 이전 작업 패턴 발견 시 사용자에게 제시
- 적용 여부 선택 가능
- 예상 효과 제시

---

## 🎯 작업 시작 전 성공 기준 합의 (필수)

### 작업 착수 전 반드시 실행

**Step 1: 입력 분석 완료 후 사용자에게 제시**
1. **예상 출력 통계**
   - 원본 신호 개수: N개
   - 추가 예상: +X개
   - 삭제 예상: -Y개
   - 변경 예상: Z개
   - 최종 예상: M개

2. **성공 기준 체크리스트** (구체적 숫자 포함)
   - [ ] 최종 신호 개수: M개 (±5% 허용)
   - [ ] 핀 중복: 0개
   - [ ] LVDS 페어 완전성: 100%
   - [ ] Excel 매칭률: 90% 이상

3. **위험 요소 명시**
   - 불확실한 부분 (확신도 < 90%)
   - 범위 외 추정 항목
   - 데이터 품질 이슈

**Step 2: 사용자 승인 대기**
- "위 기준으로 작업을 시작하겠습니다. 진행할까요?"
- 승인 전까지 파일 수정 금지
- 수정 사항 있으면 반영 후 재제시

**Step 3: 승인 후 문서화**
- claude-agent.md "Agent 실행 내용"에 성공 기준 기록
- 작업 중 성공 기준 변경 금지 (사용자 승인 필요)

---

## ⚠️ 부분 성공 처리 규칙

### 부분 성공 판정 기준

**필수 항목 (Must)** - 100% 완료 필수
- Level 1 검증 통과
- 핀 중복 0개
- 문법 오류 0개
- 파일 생성 완료

**권장 항목 (Should)** - 80% 이상 완료
- Excel 매칭률 (목표 90%, 최소 80%)
- LVDS 페어 완전성 (목표 100%, 최소 90%)
- 예상 개수 일치 (목표 100%, 오차 10% 허용)

**선택 항목 (Nice-to-have)** - 미완료 허용
- 범위 외 신호 처리
- 추가 최적화
- 상세 문서화

### 부분 성공 보고 형식

```
## 작업 완료 - 부분 성공 (Partial Success)

✅ 완료: 127개 (86%)
⚠️ 범위 외: 17개 (11%) - RF_L_* 신호들
❌ 실패: 3개 (2%) - 주석 처리로 보류

**필수 항목**: ✅ 모두 통과
**권장 항목**: ⚠️ 86% 완료 (목표 80% 이상)
**선택 항목**: - 미적용

**사용자 선택 필요**
```

### 사용자 선택지 제공

- **A) 부분 성공으로 완료 처리** (권장)
  - 완료된 86%를 최종 출력으로 확정
  - 범위 외 17개는 별도 보고서로 제공

- **B) 범위 외 항목도 강제 작업** (위험)
  - 원본에 없는 신호 추가 시도
  - 데이터 불일치 위험 높음

- **C) 실패 3개 재작업**
  - 실패 항목만 수동 처리

- **D) 전체 롤백 후 재시작**

---

## 📊 Excel 컬럼 자동 매핑 전략

### Phase 1: 컬럼명 자동 탐지

**키워드 매칭 테이블**
- 핀 번호: "핀", "Pin", "Package", "Ball", "PAD"
- 구 신호: "140um", "Old", "Original", "Before", "Source"
- 신 신호: "100um", "New", "Target", "After", "Dest"
- 비고: "Note", "Remark", "Comment", "비고"

**신뢰도 점수 계산**
- 정확 일치: 100점
- 부분 일치: 70점
- 위치 기반 추론: 50점

**판정**
- 90점 이상: 자동 진행
- 70-89점: 사용자 확인 후 진행
- 70점 미만: 수동 지정 필요

### Phase 2: 신뢰도 < 90점 시 사용자 확인

```
Excel 컬럼 해석:
- A열 (Pin): "FPGA Pin" → 핀 번호 (신뢰도 100%)
- B열 (140um): "Old Signal" → 구 신호 (신뢰도 85%)
- C열 (100um): "New Signal" → 신 신호 (신뢰도 85%)
- D열 (Note): "Remark" → 비고 (신뢰도 90%)

위 해석이 맞습니까?
```

### Phase 3: 컬럼 매핑 문서화

- 작업 기록에 사용한 매핑 명시
- 다음 동일 Excel 파일 작업 시 재사용
- "Agent 실행 내용"에 컬럼 매핑 저장

---

## 🔁 무한 루프 방지 장치

### 자동 중단 조건 (하나라도 해당 시)

1. **동일 오류 5회 연속**
   - 같은 신호/핀에서 5회 연속 실패
   - 즉시 중단, 오류 패턴 보고

2. **진행률 정체 10분**
   - 마지막 성공 항목 이후 10분 경과
   - 즉시 중단, 현재 상태 보고

3. **실패 항목 누적 100개**
   - 실패 항목이 100개 초과 시 중단
   - Pre-flight Check 오류 가능성

4. **메모리/CPU 이상**
   - 예상치 못한 시스템 부하
   - 무한 재귀 감지

### 중단 시 보고 내용

```
## 작업 중단 - 무한 루프 감지

**중단 사유**: 동일 오류 5회 연속

**마지막 성공**: 신호 #42 (DCLKP_10)
**반복 실패**: 신호 #43 (DCLKP_11)
  - 오류: 핀 번호 "B21" 중복
  - 재시도: 5회 모두 실패

**오류 패턴 분석**:
- Excel에 동일 핀 번호 2회 등장
- 데이터 소스 오류 추정

**권장 조치**:
1. Excel B21 핀 재확인
2. 중복 항목 제거 후 재시작
3. 또는 #43 건너뛰고 계속 (위험)
```

### 재개 옵션

- A) Excel 수정 후 재시작 (권장)
- B) 문제 항목 건너뛰고 계속
- C) 현재 지점부터 수동 작업
- D) 전체 취소

---

## 💬 주석 처리 규칙

### 원본 파일의 주석

**기본 정책**: 주석은 절대 삭제하지 않음
- 원본 작성자의 의도 보존
- 히스토리 추적 가능성 유지

**변경 시 주석 동기화**
- 신호명 변경 시: 주석 내 신호명도 함께 변경
- 예: `#set_property PACKAGE_PIN U21 [get_ports ROIC_RESET_R]`
  → `#set_property PACKAGE_PIN U21 [get_ports ROIC_TP_SEL]`

**주석 해제 금지**
- `#` 제거하여 활성화하는 작업 금지
- 사용자 명시적 요청 시만 예외

### 새로 추가하는 코드

**주석 추가 금지**
- 사용자가 요청한 경우만 예외
- 원본 스타일 유지 (주석 없으면 추가 안 함)

### 주석-실제 불일치 발견 시

**경고 보고**
```
⚠️ 주석-실제 코드 불일치 발견:
- 라인 28: 주석 "ROIC_RESET_R", 실제 "ROIC_TP_SEL"
- 라인 45: 주석 "RF_SPI_CS_1", 실제 주석 처리됨

이 불일치를 수정할까요?
```

---

## 🗑️ 임시 파일 정리 타이밍

### 정리 금지 시점

**절대 정리하지 않음**
- 작업 완료 직후 (검증 전)
- 사용자 최종 확인 대기 중
- 작업 완료 후 24시간 이내

### 정리 허용 시점 (모든 조건 충족 필요)

1. **사용자 명시적 확인**
   - "완료 확인" 또는 "백업 삭제 가능" 명시

2. **최종 검증 통과**
   - Level 1 + Level 2 모두 통과

3. **시간 경과**
   - 작업 완료 후 24시간 경과

4. **새 작업 시작 전**
   - 다음 작업 착수 전 이전 백업 정리

### 정리 전 사용자 확인

```
임시 파일 정리 요청:

삭제 대상 (총 5개, 126MB):
- cyan_hd_top_original_backup.xdc (42KB)
- cyan_hd_top_before_bulk_20260102.xdc (42KB)
- cyan_hd_top_checkpoint_1.xdc (45KB)
- cyan_hd_top_checkpoint_2.xdc (52KB)
- cyan_hd_top_validation_failed_20260102.xdc (58KB)

보존 (삭제 안 함):
- cyan_hd_top.xdc (최종 출력)
- verify_final.py (검증 스크립트)

계속할까요? (Y/N)
```

### 자동 정리 규칙

**30일 경과 시**
- 사용자 확인 없이 자동 정리 가능
- 단, 최초 백업(`_original_backup`)은 영구 보존

---

## 🔢 숫자 범위 처리 표준

### 범위 표기 해석 규칙

**표준 해석 (inclusive, 양 끝 포함)**
- "0-13" → 0,1,2,...,12,13 (14개)
- "0~13" → 동일
- "CH0-CH13" → CH0, CH1, ..., CH13 (14개)
- "[0:13]" → 동일

**예외 표기**
- "0-13 (14ch)" → 명시된 개수 우선
- "0..12" → 0,1,...,12 (13개, 마지막 제외)

### 자동 검증 절차

**Step 1: 범위 파싱 후 명시**
```
범위 해석:
- "CH0-CH13" → 14개 채널로 해석했습니다
- 포함: CH0, CH1, CH2, ..., CH12, CH13
```

**Step 2: 샘플 출력**
- 첫 3개: CH0, CH1, CH2
- 중간 2개: CH6, CH7
- 끝 3개: CH11, CH12, CH13

**Step 3: 개수 확인**
- 예상 개수: 14개
- 실제 생성: 14개
- 일치 여부: ✅

### 경계값 필수 검증

**작업 완료 후 Spot Check**
- 첫번째 (0): 존재 확인
- 마지막 (13): 존재 확인
- 중간 (6,7): 존재 확인
- 범위 밖 (-1, 14): 존재하지 않음 확인

**Off-by-one 오류 방지**
- `range(0, 14)` → 0~13 (올바름)
- `range(0, 13)` → 0~12 (오류!)
- 항상 `range(start, end+1)` 사용

---

## 📌 핵심 개선사항 요약 (v3.0)

### 기존 개선사항 (v1.0)
1. Pre-flight Check 추가
2. 작업 범위 결정 프로토콜
3. 검증 레벨 정의
4. 데이터 정규화 규칙
5. 에러 보고 템플릿
6. 완료 보고서 표준화
7. Python 코딩 표준
8. 검증 모드 강화

### 추가 개선사항 (v2.0)
9. 필수 멈춤 지점 (7가지 STOP 조건)
10. 가정 명시 규칙 (확신도 기반)
11. 자동 백업 트리거 (5개 시점)
12. 진행률 보고 (10개 단위, 50% 중간검증)
13. 검증 스크립트 자동 생성 (조건 명시)
14. 문제 해결 우선순위 (P0-P4 매트릭스)
15. 재시도 전략 (최대 3회)
16. 작업 취소/되돌리기 (체크포인트)
17. 데이터 소스 신뢰도 (점수화 평가)
18. 학습 및 개선 (패턴 저장)

### 최신 개선사항 (v3.0)
19. 작업 시작 전 성공 기준 합의 (필수)
20. 부분 성공 처리 규칙
21. Excel 컬럼 자동 매핑 전략
22. 무한 루프 방지 장치
23. 주석 처리 규칙
24. 임시 파일 정리 타이밍
25. 숫자 범위 처리 표준

---

## 🎓 Agent 학습 체크리스트

작업 시작 전 확인:

**v1.0 & v2.0 기본 사항**
- [ ] 7가지 멈춤 지점을 숙지했는가?
- [ ] 가정은 반드시 명시하는가?
- [ ] 5가지 백업 트리거를 이해했는가?
- [ ] 진행률을 10개 단위로 보고하는가?
- [ ] 검증 스크립트를 언제 만드는가?
- [ ] P0-P4 우선순위를 이해했는가?
- [ ] 재시도는 최대 몇 회인가? (3회)
- [ ] 롤백 절차를 숙지했는가?
- [ ] Excel 신뢰도 평가 방법을 아는가?
- [ ] 패턴 학습을 저장하는가?

**v3.0 추가 사항**
- [ ] 작업 전 성공 기준을 사용자와 합의하는가?
- [ ] 부분 성공 시나리오를 처리할 수 있는가?
- [ ] Excel 컬럼을 자동 인식하는가? (신뢰도 90% 미만 시 확인)
- [ ] 무한 루프 감지 조건을 아는가? (동일 오류 5회, 10분 정체)
- [ ] 주석은 절대 삭제하지 않는가?
- [ ] 임시 파일 정리는 24시간 후 + 사용자 확인인가?
- [ ] 숫자 범위는 inclusive(양 끝 포함)인가?

**🔴 최우선 원칙 (매 작업마다 확인)**
- [ ] 토큰 낭비를 최소화하고 있는가?
- [ ] 예상 토큰 소비가 Budget의 50% 미만인가?
- [ ] 큰 파일은 offset/limit으로 필요한 부분만 읽는가?
- [ ] 같은 파일/분석을 반복하지 않는가?
- [ ] Budget < 20% 시 즉시 중단하는가?

---

**이 문서는 실제 프로젝트 경험(cyan_hd_top.xdc 검증)을 바탕으로 개선되었습니다.**

**버전: 3.1 (2026-01-02)**
**개선 항목: 26개 (v1.0: 8개 + v2.0: 10개 + v3.0: 7개 + 최우선 원칙: 1개)**

---

# Agent 실행 내용

## 📝 작업 기록 (실제 수행한 작업 히스토리)

### 작업 이력

#### v1.0 (2026-01-02) - cyan_hd_top.xdc 생성 작업
**작업 유형**: XDC 제약 파일 생성 (140um → 100um 변환)

**입력 파일**
- top_const.xdc (140um 원본, 104핀)
- 100um_xc7a35tfgg484_Pinmap(251226).xlsx (핀맵 정의)

**출력 파일**
- cyan_hd_top.xdc (100um 최종, 147핀)

**성공 기준 달성**
- [x] 모든 핀 매핑 완료
- [x] 중복 핀 없음
- [x] LVDS 페어 완전성
- [x] 검증 스크립트 통과

**작업 내역**

Step 1: 파일 복사 ✓
- top_const.xdc → cyan_hd_top.xdc

Step 2: 신호명 변경 (47개) ✓
```
U21 : ROIC_RESET_R → ROIC_TP_SEL
P19 : ROIC_ACLK_R  → ROIC_SYNC
W21 : RF_SPI_SCK_1 → ROIC_SPI_SCK
W22 : RF_SPI_SDI_1 → ROIC_SPI_SDI
AA20: RF_SPI_SDO_1 → ROIC_SPI_SDO
P20 : R_SW_AVDDI   → ROIC_AVDD1
T21 : R_SW_BIAS    → ROIC_AVDD2
F15 : DCLK_R       → ROIC_MCLK0
```
- ROIC 데이터 신호 36개: Array 표기 제거 (예: R_ROIC_DCLKo_p[11] → DCLKP_11)

Step 3: NC 핀 삭제 (3개) ✓
```
R19 : ROIC_SYNC_R 삭제
T19 : RF_SPI_CS_1 삭제
AB18: GF_STV_LR9 삭제
```

Step 4: LVDS 신호 추가 (84개) ✓
- 14채널 (CH0-13) 완전 구성
- DCLKN_*, FCLKN_*, DOUTN_* 각 14개 (42 negative)
- CH12, CH13 positive 신호 추가 (2채널 × 3신호 = 6개)

Step 5: 검증 완료 ✓
- 중복 핀: 없음 (주석 제외)
- LVDS 페어: 완전 (14채널 × 3신호 × 2극성 = 84)
- 필수 신호: 모두 존재

**검증 스크립트**
- verify_final.py: 최종 검증 (147핀, LVDS 완전성 확인)

**최종 결과**
- 입력: top_const.xdc (140um, 104핀)
- 출력: cyan_hd_top.xdc (100um, 147핀)
- 추가: 43핀 (+41%)

---

## 🎯 다음 작업 대기 중

(새로운 작업이 수행되면 이 섹션에 기록됩니다)
