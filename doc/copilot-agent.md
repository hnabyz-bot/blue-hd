# Agent 작업 가이드

---

## 📋 작업 원칙 (Agent 지침)

### 🔴 최우선 원칙 (절대 법칙)

**리소스 최소화 - Agent의 생명줄**
- **토큰 낭비 금지**: 불필요한 파일 읽기, 중복 분석, 장황한 설명 절대 금지
- **Budget 엄수**: 작업 시작 전 예상 토큰 소비량 계산, 한도 초과 시 중단
- **효율 우선**: 같은 결과를 더 짧은 경로로 얻기
- **컨텍스트 관리**: 큰 파일은 필요한 부분만 읽기

**리소스 낭비 예시 (절대 금지)**
- ❌ 전체 파일 여러 번 읽기 → ✅ 한 번 읽고 메모리 보관
- ❌ 1000줄 파일 전체 → ✅ 필요한 100줄만
- ❌ 같은 분석 반복 → ✅ 결과를 문서에 저장하고 재사용
- ❌ 긴 설명 → ✅ 핵심만 1-2줄

### 핵심 원칙
1. **간결성**: 불필요한 설명 금지, 요점만 간단히 전달
2. **점진성**: 복잡하게 한번에 하지 말고, 단계별로 진행
3. **맥락 유지**: 전체 프로젝트 이해하고 논점에서 벗어나지 않기
4. **문서화**: 작업 방향, 순서, TODO를 md 파일에 실시간 반영
5. **투명성**: 가정은 명시, 불확실하면 멈추기

### 작업 흐름
```
1. Pre-flight Check (50개 이상 작업 시)
2. 파일 읽기 → 현재 상태 파악
3. 가정 명시 → 변경 계획 수립
4. 백업 생성 → 한 단계씩 실행
5. 즉시 검증 → 다음 단계
6. 완료 후 문서 업데이트
```

### 🛑 필수 멈춤 지점 (STOP 조건)
**자동 진행 금지 상황:**
1. 데이터 불일치 > 10% (Excel vs 원본 매칭률 90% 미만)
2. 범위 외 신호 > 20개
3. 핀 중복 발견
4. 예상 출력 개수 불일치 (오차 5% 초과)
5. Excel 신뢰도 < 70점
6. 백업 실패

**멈춤 시 대응:**
- 현재까지 분석 요약
- 불일치 항목 제시 (최대 5개)
- 예상 원인 + 가능성 %
- 사용자 선택지 제공

### 💭 가정 명시 규칙
**가정 필수 명시 항목:**
1. 가정 내용
2. 근거
3. 위험도 (낮음/중간/높음, 확신도 %)
4. 검증 방법
5. 실패 시 대응

**확신도별 행동:**
- 확신 > 90%: 진행 → 사후 검증
- 확신 70-90%: 가정 명시 → 샘플 테스트 → 진행
- 확신 < 70%: 작업 중단 → 사용자 질문

### 필수 체크사항
- [ ] 파일 존재 및 경로 확인 (`list_dir`, `file_search`)
- [ ] 편집 전 정확한 내용 읽기 (`read_file`)
- [ ] 컨텍스트 포함하여 교체 (앞뒤 3-5줄)
- [ ] 편집 후 즉시 검증 실행
- [ ] 백업 생성 (자동 트리거 시점에)

### 오류 방지
- ❌ 추측으로 편집: 반드시 읽고 확인
- ❌ 큰 블록 한번에 교체: 단계별로 나눠서
- ❌ 하드코딩: 검색으로 동적 확인
- ❌ 병렬 의존 작업: 순차 실행
- ❌ 가정 숨기기: 모든 가정은 명시

### 🔍 작업 전 사전 분석 (Pre-flight Check)
**50개 이상 대량 작업 시 필수:**

1. **데이터 소스 신뢰도 평가 (0-100점)**
   - 구조적 완전성: 헤더/컬럼 존재
   - 데이터 일관성: 형식/네이밍 규칙
   - 90점 이상: 자동 진행
   - 70-89점: 경고 후 진행
   - 70점 미만: 사용자 확인 필수

2. **통계 수집 (5분 이내)**
   - 원본 신호 개수
   - Excel 매핑 개수 (변경/추가/삭제)
   - 예상 출력 개수
   - 범위 외 추정 개수

3. **이상치 탐지**
   - 같은 핀에 여러 신호
   - 원본에 없는 신호 (10개 이상)
   - 패턴 불일치

4. **진행 조건 판단**
   - 합리적 범위 → 자동 진행
   - 10% 이상 이상치 → 사용자 확인

### 📐 작업 범위 결정
**원본 파일 기준 원칙:**
- 입력 파일에 실제 존재하는 신호만 작업 대상
- "140um 신호" 컬럼 비어있으면 → 신규 신호 (범위 외)
- "140um 신호"가 원본에 없으면 → 사용자 확인
- 매칭률 < 90% → 멈춤 지점
- 작업 완료 후 "범위 외 N개 신호" 보고

### 보고 형식
- 시작: 목표 1줄
- 진행: 단계별 ✓/⏳ 표시
- 완료: 결과 요약 + 검증 통과 여부

**대량 작업 시 (50개 이상) 진행률 보고:**
- 10개 단위로 보고
- 진행바 표시 (N/M, %)
- 예상 완료 시간
- 중간 검증 (50% 시점)

### 작업 분석 방법론
```
Step 1: 데이터 소스 파악
  - 입력 파일 구조 분석 (read_file로 샘플 확인)
  - Excel: Python openpyxl로 파싱, 데이터 구조 파악
  - XDC: 정규식으로 핀/신호 추출
  
Step 2: 변경점 통계
  - 유지/변경/삭제/추가 항목 분류
  - 작업량 산정 (10개 이하: 수동, 10개 이상: 스크립트)
  
Step 3: 작업 순서 수립
  - 의존성 고려 (삭제 → 변경 → 추가)
  - 검증 시점 계획 (중간 검증 + 최종 검증)
```

### 대량 작업 전략
- **10개 미만**: `multi_replace_string_in_file` 직접 사용
- **10개 이상**: 
  1. Python 스크립트 생성 (매핑 테이블 기반)
  2. 스크립트로 변경 리스트 생성
  3. 생성된 리스트로 일괄 교체
- **패턴 작업**: Excel/CSV 데이터를 순회하며 변환 적용

### 검증 자동화
**검증 레벨 정의:**

**Level 1 - 필수 검증 (항상 실행)**
- 핀 중복: 0개
- 문법 오류: 없음
- 파일 생성: 확인

**Level 2 - 완전성 검증 (작업 완료 시)**
- 신호 개수: 예상과 일치 (오차 5% 허용)
- LVDS 페어: 모든 _p/_n 쌍 존재
- 필수 신호: 모두 존재

**Level 3 - 교차 검증 (사용자 요청 시)**
- Excel vs XDC 매핑 확인
- 원본 vs 출력 diff 분석
- 범위 외 항목 보고

**검증 실패 우선순위:**
- Level 1 실패: P0 - 즉시 중단
- Level 2 실패: P1 - 경고 + 재작업
- Level 3 불일치: P2-P3 - 정보 제공

```python
# 필수 검증 항목
1. 중복 검사: Counter로 핀 번호 카운트
2. 완전성 검사: 예상 개수 vs 실제 개수
3. 형식 검사: 정규식으로 패턴 매칭
4. 차분 검사: 변경 전후 diff
```

**검증 스크립트 필수 생성 조건:**
- 50개 이상 변경
- LVDS 페어 작업
- 핀 매핑 작업

**검증 스크립트 템플릿:**
- 입력: 파일 경로
- 출력: 통과/실패 + 상세 리스트
- 재사용: 다른 프로젝트에도 적용 가능하게

### 문제 해결 패턴

**문제 우선순위 매트릭스:**

| 문제 유형 | 원인 | 해결 방법 | 우선순위 |
|----------|------|----------|---------|
| 교체 실패 | 공백/개행 불일치 | 해당 라인 `read_file`로 정확히 확인 | P1 |
| 중복 핀 | 데이터 충돌 | Excel 재확인, 주석 처리된 것인지 검증 | P0 |
| 누락 항목 | 범위 오해석 | 데이터 소스 재분석, 채널/범위 재확인 | P1 |
| 대량 오류 | 패턴 오류 | 작은 샘플로 테스트 후 전체 적용 | P2 |
| 의존성 오류 | 순서 잘못 | 작업 순서 재검토 (삭제→수정→추가) | P1 |
| 백업 실패 | 디스크/권한 | 작업 즉시 중단 | P0 |
| 범위 외 신호 | 신규 신호 포함 | Pre-flight Check로 사전 탐지 | P2 |

**우선순위 분류:**
- **P0**: 즉시 중단 (핀 중복, 백업 실패)
- **P1**: 다음 단계 전 해결 (매핑 실패 10% 이상)
- **P2**: 작업 완료 후 해결 (범위 외 신호 < 20개)
- **P3**: 사용자 판단 (최적화 제안)
- **P4**: 문서화만 (참고 정보)

### 작업 체크리스트
```
작업 전:
□ 입력 파일 존재 확인
□ Excel 신뢰도 평가 (품질 체크)
□ Pre-flight Check 실행 (50개 이상)
□ 가정 명시 (불확실한 부분)
□ 백업 디렉토리 준비
□ 범위 외 항목 확인
□ 작업 순서 계획 수립

작업 중:
□ 자동 백업 (트리거 시점마다)
□ 단계별 즉시 검증
□ 진행률 보고 (10개 단위, 50개 이상 시)
□ 중간 검증 (50% 시점)
□ 실패 시 재시도 (최대 3회)
□ 진행 상황 md 파일 업데이트

작업 후:
□ 최종 검증 스크립트 실행 (Level 1 + 2)
□ 성공 기준 모두 충족 확인
□ 범위 외 항목 보고
□ 작업 완료 보고서 작성
□ 작업 이력 문서화
□ 생성한 임시 파일 정리
```

### 💾 자동 백업 트리거
**필수 백업 시점 (자동):**
1. 최초 원본 읽기 직후: `파일명_original_backup.ext` (삭제 금지)
2. 10개 이상 변경 전: `파일명_before_bulk_YYYYMMDD.ext`
3. 주요 단계 완료 후: `파일명_checkpoint_N.ext`
4. 50% 완료: `파일명_checkpoint_50pct.ext`
5. 검증 실패 직전: `파일명_validation_failed.ext`

**백업 실패 시:** 작업 즉시 중단 (롤백 불가능)

### 🔄 재시도 전략
**자동 재시도 조건 (최대 3회):**
- 파일 읽기 실패: 1초 간격
- 패턴 매칭 실패: 정규화 후 1회

**재시도 금지:**
- 사용자 입력 오류
- 논리적 오류 (중복 핀, 데이터 모순)
- 영구적 오류 (파일 없음, 권한 부족)

### 데이터 해석 규칙
**공통 규칙:**
- Excel/CSV에서 `-` 또는 빈칸: "변경 없음" (삭제 아님)
- `NC` 또는 `No Connect`: 삭제 대상
- 대소문자 구분: 원본과 동일하게 유지

**숫자 표기 정규화:**
- Excel: `SIGNAL_05` (2자리) → XDC: `SIGNAL_5` (1자리) 허용
- 검증 시 정규화 함수 사용 (선행 0 제거)

**신호명 매핑 우선순위:**
1. 정확히 일치 (exact match)
2. 정규화 후 일치 (normalized match)
3. 핀 번호 기반 추정 (pin-based inference)
4. 불일치 → 사용자 확인

**FPGA XDC 특수 규칙:**
- LVDS 신호: `_p` (positive) + `_n` (negative) 페어로 존재
- Array 표기: `{신호명[N]}` → 단일 신호로 변환 시 `신호명_N`
- IOSTANDARD: 같은 Bank는 동일 표준 사용

**의심스러운 데이터:**
- 같은 핀에 여러 신호 매핑 → 사용자 확인 필요
- 범위가 불명확 (예: 0-13인지 0-22인지) → 데이터 소스 재확인
- 새로운 패턴 발견 → 샘플 테스트 후 적용

### 불확실성 처리 전략
```
불확실도 Level 1 (높음): 작업 중단 → 사용자 질문
  - 데이터 모순 (Excel과 파일 불일치)
  - 명확한 규칙 없음
  - 영향도가 큰 결정

불확실도 Level 2 (중간): 보수적 접근 → 문서화
  - 샘플 테스트 먼저
  - 가정을 명시하고 진행
  - 검증 강화

불확실도 Level 3 (낮음): 진행 → 사후 검증
  - 패턴이 명확함
  - 작은 범위 작업
  - 쉽게 되돌릴 수 있음
```

### 에러 복구 전략
**체크포인트 생성:**
```
- 작업 시작: 원본_backup_YYYYMMDD.ext
- 주요 단계 완료: 파일명_step1.ext, _step2.ext
- 대량 작업 전: 파일명_before_bulk.ext
```

**롤백 절차:**
1. 문제 발생 시점 파악
2. 해당 체크포인트로 복원
3. 문제 원인 분석 후 재작업

**부분 롤백:**
- 특정 변경만 취소: 백업과 diff → 해당 부분만 복원
- `git`이 있으면 활용 (commit 단위로 체크포인트)

### ⏮️ 작업 취소 및 되돌리기
**사용자 중단 요청 시:**

1. **현재 진행 상황 보고**
   - 완료된 단계
   - 진행 중인 단계 (진행률)
   - 대기 중인 단계

2. **사용 가능한 체크포인트 제시**
   - 원본 상태
   - 각 단계별 체크포인트
   - 현재 상태 유지

3. **선택지 제공**
   - A) 특정 체크포인트로 롤백 (권장 제시)
   - B) 원본으로 완전 복원
   - C) 현재 상태 유지

**부분 완료 상태 유지 시:** 불완전 상태 명시 + 위험 설명

### 샘플 기반 검증
**테스트 범위 결정:**
```
전체 N개 작업 시:
- N < 10: 전체 검토
- 10 ≤ N < 50: 처음 3개 샘플 테스트
- N ≥ 50: 처음/중간/끝 각 2개씩 (총 6개)
```

**샘플 검증 절차:**
1. 대표 샘플 선택 (다양한 패턴 포함)
2. 수동으로 변경 적용
3. 검증 스크립트 실행
4. 통과 시 전체 적용, 실패 시 패턴 수정

**전체 적용 후 Spot Check:**
- 무작위 5% 샘플링
- 경계값 확인 (첫번째, 마지막, 중간)
- 예외 케이스 집중 검토

### 사용자 상호작용 프로토콜
**명령어 패턴 인식:**
- "숙지해/이해해/읽어봐" → 파일 읽기 + 분석만, 수정 없음
- "비교해/분석해" → 차이점 파악 + 보고, 수정 없음
- "작성해/생성해/수정해" → 실제 파일 편집 수행
- "검증해" → 검증만 실행 (Level 1 + 2), 수정 없음

**질문 필요 시점:**
```
즉시 질문 (작업 중단):
- 데이터 모순 발견
- 삭제 대상이 애매함 (주석? 진짜 삭제?)
- 범위/채널 불명확
- 매칭률 < 90%

확인 후 진행 (가정 명시):
- 패턴이 명확하지만 확신 80% 이하
- 영향 범위가 크지 않음

진행 후 보고:
- 확신 90% 이상
- 검증으로 확인 가능
```

### 🚨 에러 보고 템플릿 (4W)
**필수 포함 정보:**
1. **What**: 무엇이 실패했는지 (구체적)
2. **Where**: 어디서 발생했는지 (파일:라인)
3. **Why**: 왜 발생했는지 (추정 원인)
4. **hoW**: 어떻게 해결할지 (다음 액션)

**추가 포함:**
- 영향도 (치명적/높음/중간/낮음)
- 우선순위 (P0-P4)
- 해결 방안 (단계별)

### 📝 작업 완료 보고서 템플릿
**필수 포함 항목:**

1. **요약**
   - 입력 파일 (N개 신호)
   - 출력 파일 (M개 신호)
   - 변경 내역 (+X, -Y, 수정 Z)
   - 소요 시간

2. **검증 결과**
   - Level 1 결과
   - Level 2 결과
   - Level 3 결과 (있는 경우)

3. **작업 내역**
   - 단계별 상세 내용
   - 각 단계 완료 여부

4. **범위 외 항목** (있는 경우)
   - 총 개수
   - 예시 (5개)
   - 권장사항

5. **생성 파일**
   - 최종 출력 파일
   - 검증 스크립트
   - 백업 파일 목록

### 🐍 Python 스크립트 작성 규칙
**Windows 환경 필수:**
- UTF-8 인코딩 명시 (한글 출력 시)
- Raw string 사용 (경로 처리)
- 예외 처리 (FileNotFoundError, PermissionError)

**출력 형식:**
- 성공: `OK:`
- 실패: `FAIL:`, `ERROR:`
- 경고: `WARNING:`

### 도구 선택 결정 트리
```
파일 수정 시:
├─ 1개 수정 → replace_string_in_file
├─ 2-5개 독립적 수정 → multi_replace_string_in_file
├─ 10개 이상 패턴 작업 → Python 스크립트 생성
└─ 전체 재생성 → create_file (신규 생성만)

검증 시:
├─ 간단 확인 → grep_search, read_file
├─ 통계/카운트 → Python one-liner
└─ 복잡 검증 → Python 스크립트 파일 생성

백업 시:
├─ 원본 수정 전 → PowerShell Copy-Item
└─ git 사용 가능 → git commit
```

### 작업 완료 판단 기준
**완료 = 3단계 모두 통과**
```
1단계: 작업 목표 달성
  - 성공 기준 체크리스트 모두 ✓
  - 요청받은 출력 파일 생성

2단계: 검증 통과
  - 자동 검증 스크립트 실행 → 통과
  - 수동 Spot Check → 이상 없음
  
3단계: 부작용 확인
  - 다른 파일 영향도 체크
  - 원본 파일 백업 확인
  - 임시 파일 정리 완료
```

**재검토 트리거:**
- 검증 실패
- 예상과 다른 결과 (핀 개수, 신호명 등)
- 사용자가 "확인해봐" 요청

### 작업 범위 통제
**최소 요구사항 (Must):**
- 요청받은 파일 생성/수정
- 기본 검증 (문법, 중복)
- 간단한 작업 기록

**권장 사항 (Should):**
- 자동 검증 스크립트 생성
- 상세 작업 기록 문서화
- 백업 파일 생성

**선택 사항 (Nice-to-have):**
- 추가 분석 도구
- 상세 리포트 문서
- 시각화/통계

**판단 기준:**
- 사용자가 명시적 요청 → Must
- 작업 복잡도 높음 + 재사용 가능 → Should
- 시간 여유 + 부가가치 명확 → Nice-to-have

### 이 문서 업데이트 전략
**작업 전: 프로젝트 정보 + 작업 목표**
```markdown
## 🎯 현재 프로젝트 정보
- 프로젝트 정보 작성
- 입력/출력 파일 테이블
- 성공 기준 체크리스트 (□ 미완료 상태)
```

**작업 중: 실시간 진행 상황**
- 성공 기준 체크박스 업데이트 (□ → ☑)
- 주요 이슈 발견 시 문제 해결 패턴 추가

**작업 후: 작업 이력 + 작업 상세**
```markdown
## 📝 작업 기록
### 작업 이력
- 버전 정보 추가 (v1.0, v1.1...)

### 작업 상세
- Step별 상세 내역
- 검증 결과
- 생성한 파일 목록
```

**업데이트 시점:**
- 작업 시작: 프로젝트 정보 확인/업데이트
- 중간 체크포인트: 성공 기준 체크박스 업데이트
- 작업 완료: 전체 작업 기록 작성

---

## 🎯 현재 프로젝트 정보 (Agent 숙지 필요)

### 프로젝트
- **분야**: Xilinx FPGA 설계
- **작업 유형**: XDC 제약 파일 생성 (140um → 100um 변환)
- **작업 일자**: 2026-01-02

### 입력 파일
| 파일명 | 역할 | 비고 |
|--------|------|------|
| top_const.xdc | 140um 원본 | 104핀 |
| 100um_xc7a35tfgg484_Pinmap(251226).xlsx | 핀맵 정의 | "-"는 변경없음 |

### 출력 파일
| 파일명 | 역할 | 목표 |
|--------|------|------|
| cyan_hd_top.xdc | 100um 최종 | xlsx + top_const 기반 생성 |

---

# Agent 실행 내용

## ✅ 작업 목표 (Agent 실행 계획)

### 성공 기준
- [x] 모든 핀 매핑 완료
- [x] 중복 핀 없음
- [x] LVDS 페어 완전성
- [x] 검증 스크립트 통과

---

## 📝 작업 기록 (완료된 내용)

### 작업 이력

### v1.0 (2026-01-02) - 초기 생성
- 140um → 100um 변환 완료
- 147핀 구성 (104→147, +43)
- 14채널 LVDS 완전 구현
- 검증: verify_final.py 통과

---

## 작업 상세

### 최종 결과
✓ **cyan_hd_top.xdc** 생성 완료
- 입력: top_const.xdc (140um, 104핀)
- 출력: cyan_hd_top.xdc (100um, 147핀)
- 추가: 43핀 (+41%)

### 작업 내역

**Step 1: 파일 복사 ✓**
- top_const.xdc → cyan_hd_top.xdc

**Step 2: 신호명 변경 (47개) ✓**
```
U21 : ROIC_RESET_R → ROIC_TP_SEL
P19 : ROIC_ACLK_R  → ROIC_SYNC
W21 : RF_SPI_SCK_1 → ROIC_SPI_SCK
W22 : RF_SPI_SDI_1 → ROIC_SPI_SDI
AA20: RF_SPI_SDO_1 → ROIC_SPI_SDO
P20 : R_SW_AVDDI   → ROIC_AVDD1
T21 : R_SW_BIAS    → ROIC_AVDD2
F15 : DCLK_R       → ROIC_MCLK0
```
- ROIC 데이터 신호 36개: Array 표기 제거 (예: R_ROIC_DCLKo_p[11] → DCLKP_11)

**Step 3: NC 핀 삭제 (3개) ✓**
```
R19 : ROIC_SYNC_R 삭제
T19 : RF_SPI_CS_1 삭제
AB18: GF_STV_LR9 삭제
```

**Step 4: LVDS 신호 추가 (84개) ✓**
- 14채널 (CH0-13) 완전 구성
- DCLKN_*, FCLKN_*, DOUTN_* 각 14개 (42 negative)
- CH12, CH13 positive 신호 추가 (2채널 × 3신호 = 6개)

**Step 5: 검증 완료 ✓**
- 중복 핀: 없음 (주석 제외)
- LVDS 페어: 완전 (14채널 × 3신호 × 2극성 = 84)
- 필수 신호: 모두 존재

### 검증 스크립트
- **verify_final.py**: 최종 검증 (147핀, LVDS 완전성 확인)

